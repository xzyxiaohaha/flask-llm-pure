<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepSeek æ™ºèƒ½å¯¹è¯</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>DeepSeek æ™ºèƒ½å¯¹è¯åŠ©æ‰‹</h1>
            <div class="session-info">
                <span>ä¼šè¯ID: <span id="session-id">{{ session.session_id }}</span></span>
                <button id="clear-btn" class="btn-secondary">æ¸…ç©ºå¯¹è¯</button>
            </div>
        </header>

        <div class="chat-container">
            <div id="chat-messages" class="chat-messages">
                <!-- æ¶ˆæ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>

            <div class="input-area">
                <div class="input-group">
                    <textarea id="message-input" placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..." rows="3"></textarea>
                    <button id="send-btn" class="btn-primary">å‘é€</button>
                </div>
                <div class="info-text">
                    <span>æ”¯æŒå¤šè½®å¯¹è¯ï¼Œæ‰€æœ‰å¯¹è¯è®°å½•å°†è‡ªåŠ¨ä¿å­˜åˆ°Excelæ–‡ä»¶</span>
                </div>
            </div>
        </div>

        <div id="loading" class="loading hidden">
            <div class="spinner"></div>
            <span>DeepSeekæ­£åœ¨æ€è€ƒä¸­...</span>
        </div>
    </div>

    <script>
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const clearBtn = document.getElementById('clear-btn');
        const loading = document.getElementById('loading');

        // åŠ è½½å†å²è®°å½•
        function loadHistory() {
            fetch('/history')
                .then(response => response.json())
                .then(data => {
                    chatMessages.innerHTML = '';
                    data.history.forEach(msg => {
                        addMessage(msg.role, msg.content);
                    });
                    scrollToBottom();
                });
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
        function addMessage(role, content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}-message`;

            const avatar = role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';
            const name = role === 'user' ? 'ä½ ' : 'DeepSeek';

            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="avatar">${avatar}</span>
                    <span class="name">${name}</span>
                </div>
                <div class="message-content">${formatMessage(content)}</div>
            `;

            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        // æ ¼å¼åŒ–æ¶ˆæ¯å†…å®¹ï¼ˆå¤„ç†æ¢è¡Œç­‰ï¼‰
        function formatMessage(content) {
            return content.replace(/\n/g, '<br>');
        }

        // æ»šåŠ¨åˆ°åº•éƒ¨
        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // å‘é€æ¶ˆæ¯
        function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addMessage('user', message);
            messageInput.value = '';

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            loading.classList.remove('hidden');
            sendBtn.disabled = true;

            // å‘é€åˆ°åç«¯
            fetch('/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message: message })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    addMessage('assistant', `é”™è¯¯: ${data.error}`);
                } else {
                    addMessage('assistant', data.response);
                }
            })
            .catch(error => {
                addMessage('assistant', `ç½‘ç»œé”™è¯¯: ${error}`);
            })
            .finally(() => {
                loading.classList.add('hidden');
                sendBtn.disabled = false;
                messageInput.focus();
            });
        }

        // æ¸…ç©ºå¯¹è¯
        function clearChat() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºå½“å‰å¯¹è¯å†å²å—ï¼Ÿ')) {
                fetch('/clear', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            chatMessages.innerHTML = '';
                            location.reload(); // é‡æ–°åŠ è½½ä»¥è·å–æ–°çš„ä¼šè¯ID
                        }
                    });
            }
        }

        // äº‹ä»¶ç›‘å¬
        sendBtn.addEventListener('click', sendMessage);
        clearBtn.addEventListener('click', clearChat);

        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // åˆå§‹åŒ–
        loadHistory();
        messageInput.focus();
    </script>
</body>
</html>