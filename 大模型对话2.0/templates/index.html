<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepSeek æ™ºèƒ½å¯¹è¯</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>DeepSeek æ™ºèƒ½å¯¹è¯åŠ©æ‰‹</h1>
            <div class="session-controls">
                <div class="session-selector">
                    <label for="session-select">é€‰æ‹©ä¼šè¯:</label>
                    <select id="session-select">
                        <option value="">-- é€‰æ‹©ä¼šè¯ --</option>
                    </select>
                    <button id="new-session-btn" class="btn-secondary">æ–°å»ºä¼šè¯</button>
                    <button id="refresh-sessions-btn" class="btn-secondary">åˆ·æ–°åˆ—è¡¨</button>
                </div>
                <div class="session-info">
                    <span>å½“å‰ä¼šè¯ID: <span id="session-id">{{ session.session_id }}</span></span>
                    <button id="clear-btn" class="btn-secondary">æ¸…ç©ºå½“å‰ä¼šè¯</button>
                </div>
            </div>
        </header>

        <div class="chat-container">
            <div id="chat-messages" class="chat-messages">
                <!-- æ¶ˆæ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>

            <div class="input-area">
                <div class="input-group">
                    <textarea id="message-input" placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..." rows="3"></textarea>
                    <button id="send-btn" class="btn-primary">å‘é€</button>
                </div>
                <div class="info-text">
                    <span>æ”¯æŒå¤šè½®å¯¹è¯ï¼Œæ‰€æœ‰å¯¹è¯è®°å½•å°†è‡ªåŠ¨ä¿å­˜åˆ°Excelæ–‡ä»¶</span>
                </div>
            </div>
        </div>

        <div id="loading" class="loading hidden">
            <div class="spinner"></div>
            <span>DeepSeekæ­£åœ¨æ€è€ƒä¸­...</span>
        </div>
    </div>

    <script>
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const clearBtn = document.getElementById('clear-btn');
        const sessionSelect = document.getElementById('session-select');
        const newSessionBtn = document.getElementById('new-session-btn');
        const refreshSessionsBtn = document.getElementById('refresh-sessions-btn');
        const loading = document.getElementById('loading');

        // åŠ è½½ä¼šè¯åˆ—è¡¨
        function loadSessions() {
            fetch('/sessions')
                .then(response => response.json())
                .then(data => {
                    sessionSelect.innerHTML = '<option value="">-- é€‰æ‹©ä¼šè¯ --</option>';
                    data.sessions.forEach(session => {
                        const option = document.createElement('option');
                        option.value = session.ä¼šè¯ID;
                        const date = new Date(session.æœ€åæ´»åŠ¨).toLocaleString();
                        option.textContent = `${session.ä¼šè¯ID.substring(0, 8)}... (${session.æ¶ˆæ¯æ•°é‡} æ¡æ¶ˆæ¯, ${date})`;
                        sessionSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('åŠ è½½ä¼šè¯åˆ—è¡¨å¤±è´¥:', error);
                });
        }

        // åˆ‡æ¢ä¼šè¯
        function switchSession(sessionId) {
            if (!sessionId) return;

            fetch('/switch_session', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ session_id: sessionId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('session-id').textContent = data.session_id;
                    displayHistory(data.history);
                    messageInput.focus();
                } else {
                    alert('åˆ‡æ¢ä¼šè¯å¤±è´¥: ' + data.error);
                }
            })
            .catch(error => {
                console.error('åˆ‡æ¢ä¼šè¯å¤±è´¥:', error);
                alert('åˆ‡æ¢ä¼šè¯å¤±è´¥');
            });
        }

        // åˆ›å»ºæ–°ä¼šè¯
        function createNewSession() {
            fetch('/new_session', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('session-id').textContent = data.session_id;
                    chatMessages.innerHTML = '';
                    sessionSelect.value = '';
                    messageInput.focus();
                    alert(data.message);
                } else {
                    alert('åˆ›å»ºæ–°ä¼šè¯å¤±è´¥');
                }
            })
            .catch(error => {
                console.error('åˆ›å»ºæ–°ä¼šè¯å¤±è´¥:', error);
                alert('åˆ›å»ºæ–°ä¼šè¯å¤±è´¥');
            });
        }

        // æ˜¾ç¤ºå†å²è®°å½•
        function displayHistory(history) {
            chatMessages.innerHTML = '';
            history.forEach(msg => {
                addMessage(msg.role, msg.content, false);
            });
            scrollToBottom();
        }

        // åŠ è½½å†å²è®°å½•
        function loadHistory() {
            fetch('/history')
                .then(response => response.json())
                .then(data => {
                    displayHistory(data.history);
                });
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
        function addMessage(role, content, animate = true) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}-message`;

            if (animate) {
                messageDiv.style.animation = 'fadeIn 0.3s ease-in';
            }

            const avatar = role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';
            const name = role === 'user' ? 'ä½ ' : 'DeepSeek';

            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="avatar">${avatar}</span>
                    <span class="name">${name}</span>
                </div>
                <div class="message-content">${formatMessage(content)}</div>
            `;

            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        // æ ¼å¼åŒ–æ¶ˆæ¯å†…å®¹ï¼ˆå¤„ç†æ¢è¡Œç­‰ï¼‰
        function formatMessage(content) {
            return content.replace(/\n/g, '<br>');
        }

        // æ»šåŠ¨åˆ°åº•éƒ¨
        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // å‘é€æ¶ˆæ¯
        function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addMessage('user', message);
            messageInput.value = '';

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            loading.classList.remove('hidden');
            sendBtn.disabled = true;

            // å‘é€åˆ°åç«¯
            fetch('/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message: message })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    addMessage('assistant', `é”™è¯¯: ${data.error}`);
                } else {
                    addMessage('assistant', data.response);
                    // å‘é€æ¶ˆæ¯ååˆ·æ–°ä¼šè¯åˆ—è¡¨ï¼Œæ›´æ–°æ¶ˆæ¯æ•°é‡
                    loadSessions();
                }
            })
            .catch(error => {
                addMessage('assistant', `ç½‘ç»œé”™è¯¯: ${error}`);
            })
            .finally(() => {
                loading.classList.add('hidden');
                sendBtn.disabled = false;
                messageInput.focus();
            });
        }

        // æ¸…ç©ºå¯¹è¯
        function clearChat() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºå½“å‰å¯¹è¯å†å²å—ï¼Ÿ')) {
                fetch('/clear', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            chatMessages.innerHTML = '';
                            document.getElementById('session-id').textContent = data.session_id;
                            sessionSelect.value = '';
                            loadSessions();
                        }
                    });
            }
        }

        // äº‹ä»¶ç›‘å¬
        sendBtn.addEventListener('click', sendMessage);
        clearBtn.addEventListener('click', clearChat);
        newSessionBtn.addEventListener('click', createNewSession);
        refreshSessionsBtn.addEventListener('click', loadSessions);

        sessionSelect.addEventListener('change', (e) => {
            if (e.target.value) {
                switchSession(e.target.value);
            }
        });

        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // åˆå§‹åŒ–
        loadSessions();
        loadHistory();
        messageInput.focus();
    </script>
</body>
</html>